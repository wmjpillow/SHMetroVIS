<DOCTYPE html>
  <meta charset="utf-8">
  <title>SH Metro</title>
  <head>
      <div id= 'img'></div>
        <div id = 'geo'></div> 
        <div id = 'chart'></div> 
  </head>
  <style>
body {
/* background: linear-gradient(rgb(30,30,30), rgb(25,25,25)); */
background:rgb(30,30,30);
background-attachment: fixed;
background-repeat: no-repeat;
}
#chart {
width: 1200px;
margin: 55px auto;
z-index: 10;
}
#geo {
width: 1200px;
height:600px;
margin: 5px auto;
z-index: 10;
}
svg {
background: none;
}
.axis path {
  fill: none;
}
.axis line {
stroke: #FCFCFC;
}
div.tooltip {	
  position: absolute;
  text-align: left;
  padding: 12px;
  font-size: 16px;
  font-family: 'Cormorant Garamond', serif;
  background: rgba(250, 250, 250, 0.75);
  border-radius: 3px;
  pointer-events: none;
}
rect {
  fill: none;
  pointer-events: all;
  z-index: -10;
}
circle {
  fill: none;
  stroke-width: 2.5px;
}
line.x{
  stroke:white;
  stroke-width: 3.8px;
  z-index: 30;
  opacity:0.8;
}
line.y{
  stroke:white;
  stroke-width: 7.8px;
  z-index: 30;
  opacity:0.8;
}
.connection{
  /* stroke:white; */
  /* stroke-width: 0.9px; */
  opacity:0.8;
}
.shadow{
  fill:black;
  opacity:0.8;
}
.shadowL1{
  fill: rgb(30,30,30);
  opacity:0.9;
}
.shadowL2{
  fill:rgb(30,30,30);
  opacity:0.9;
}
.shadowL3{
  fill:rgb(30,30,30);
  opacity:0.7;
}
.shadowL4{
  fill:rgb(30,30,30);
  opacity:0.7;
}
.shadowL5{
  fill:rgb(30,30,30);
  opacity:0.5;
}
.shadowL6{
  fill:rgb(30,30,30);
  opacity:0.5;
}
.imgline{
  stroke:red;
  stroke-width: 7.8px;
  z-index: 30;
}
  </style>
  <body>
    
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script>
//canvas
var margin={top:75, right:35, bottom:125, left:15},
  width=1200-margin.left,
  height=2500-margin.top-margin.bottom;
var svg1=d3.select("#chart").append("svg")
  .attr("width",width+margin.left+margin.right)
  .attr("height",height+margin.top+margin.bottom)
.append("g")
  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

//geocanvas setting
var geo = d3.select("#geo");
geo.width=600;
geo.height=600;
geo.attr("width",geo.width).attr("height",geo.height);
geo.margin = ({top: 5, right: 5, bottom: 5, left: 5});
var geocanvas=geo.append("svg")
   .attr("width",geo.width).attr("height",geo.height);
geocanvas.width=geo.width;
geocanvas.height=geo.height;
// geocanvas.attr("width", geocanvas.width)
//          .attr("height", geocanvas.height)
//          .attr("transform","translate("+geo.margin.left+","+geo.margin.top+")");

//station image canvas
var imgsvg=d3.select("#img").append("svg")
       .attr("width",1500-margin.right)
       .attr("height",1500)

//append div for tooltip on hover:
var div=d3.select("body").append("div")
      .attr("class","tooltip")
      .style("opacity",0);
var hightlight;
var geopoint=null;
    
//load data
d3.json('connections_by_station_name.json').then(function(d) {
    connections=d;
    console.log(connections);

d3.json('stations_by_name.json').then (function(data){
  stationsraw=data;
  // console.log(stationsraw);
  var data=d3.keys(data)
      .map(function(d){
        return {"STATION":d,"LINE_NO":data[d].LINE_NO,"LAT":data[d].LAT,"LNG":data[d].LNG,"SERIAL_NO":data[d].SERIAL_NO,
        "ST_HORIZONTAL":data[d].ST_HORIZONTAL,"ST_NAME":data[d].ST_NAME,"ST_NAME_EN":data[d].ST_NAME_EN,"ST_NO":data[d].ST_NO,
        "TRANSFER_TAG":data[d].TRANSFER_TAG,"X":data[d].X,"Y":data[d].Y,"img":data[d].img}
      })
  data.sort(function(x,y){
    return d3.ascending(x.LINE_NO,y.LINE_NO);
  });
  stationline=d3.keys(data)
      .map(function(d){
        return {"INDEX":d,"STATION":data[d].STATION,"LINENO":data[d].LINE_NO,"LAT":data[d].LAT,"LNG":data[d].LNG,"SERIAL_NO":data[d].SERIAL_NO,
        "ST_HORIZONTAL":data[d].ST_HORIZONTAL,"ST_NAME":data[d].ST_NAME,"ST_NAME_EN":data[d].ST_NAME_EN,"ST_NO":data[d].ST_NO,
        "TRANSFER_TAG":data[d].TRANSFER_TAG,"X":data[d].X,"Y":data[d].Y,"img":data[d].img}
      })
  // console.log(data)
  console.log(stationline)
  Drawstationline(stationline)
  Drawgeocanvas(stationline)
  Drawstationimg(stationline)
  // Drawstationgeo(stationline)   
  //entry data
  d3.json('every5minute_entry0401_list.json').then (function(data){ 
       data=d3.keys(data)
          .map(function(d){
              return {"time":d,"stations":data[d]}
                          });
        // console.log(data);
       data.forEach(function(d,i){
            stations=d.stations
            stations=d3.keys(d.stations)
           .map(function(d){
            return {"index":d,"station":stations[d][0],"pop":stations[d][1],"id":stations[d][0]}
                           })
            stations.forEach(function(d,i){
           stationline.forEach(function(x,j){
               if(d.station==x.STATION){
                    d.index=x.INDEX    }
                                            })
                                          })
      //  console.log(stations)
      //  console.log(i)
     DrawHeatmapRow(stations,i);
    hightlight=svg1.append('g')
              .attr("class","hightlightline")
              .style("display",'none');
    hightlight.append("line")
              .classed('x',true);
    hightlight.append("line")
              .classed('y',true);
                                    });
});

});
});

// Variables for colors and legend:
var mint = "#05B89A",
  teal = "#0B90B6",
  corn = "#FFCE65",
  yellow = "#FFC039",
  gold = "#FFC707",
  orange = "#FF9339",
  sun = "#FF6307",
  heart = "#FF4739",
  red = "#FF1907",
  hot = "960018",
  lawngreen="#7CFC00",
  rebeccapurple="#663399",
  mediumslateblue="#7b68ee",
  orchid="#ff1a75",
  blue="#4169E1",
  lightskyblue="#87cefa",
  mediumpurple="#9370db",
  saddlebrown="#8b4513",
  green="#004d00",
  lightpink="#ff99cc",
  mediumaquamarine="#66DDAA",
  colors = [ "#05B89A", "#0B90B6", "#FFCE65", "#FFC039", "#FFC707", "#FF9339", "#FF6307", "#FF4739", "#FF1907", "960018" ],
  legendScale = ["0 - 3", "3 - 5.5", "5.5 - 6", "6 - 6.5", "6.5 - 7", "7 - 8.5", "8.5 - 9", "9 - 9.5", "9.5 - 10", "10+"];
//scale population to color
var colorScale=function(pop){
if(pop>=0 && pop<100){return mint;}
else if(pop>=100 && pop<300){return teal;}
else if(pop>=300 && pop<500){return corn;}
else if(pop>=500 && pop<750){return yellow;}
else if(pop>=750 && pop<1000){return gold;}
else if(pop>=1000 && pop<1200){return orange;}
else if(pop>=1200 && pop<1400){return sun;}
else if(pop>=1400 && pop<1600){return heart;}
else if(pop>=1600 && pop<1800){return red;}
else if(pop>=1800 && pop<2000){return hot;}
};
//render the data in an svg
function DrawHeatmapRow(stations,i){
svg1.selectAll("svg1")
   .data(stations)
   .enter().append("rect")
   .attr("class","tile")
   .attr("x",x=i*4)
   .attr("y", function(d,j){ return y=d.index*8;})
   .attr("id",function(d){return d.id;})
   .attr("width",3.8)
   .attr("height",7.8)
   .attr("transform", "translate(0,-20)")
   .style("fill",function(d){return colorScale(d.pop);})
   .style("opacity",1)
   .attr("class","rect")
     .on("mouseover",function(d){
      console.log(d);
      console.log(this);
      hightlight.style("display",null)
            .attr("transform", "translate(0,-20)");
      hightlight.select("line.x")
            .attr("x1",(d3.select(this).attr('x')*2+3.8)/2)
            .attr("y1",0)
            .attr("x2",(d3.select(this).attr('x')*2+3.8)/2)
            .attr("y2",(d3.select(this).attr('y')*2+7.8)/2);
      hightlight.select("line.y")
            .attr("x1",100)
            .attr("y1",(d3.select(this).attr('y')*2+7.8)/2)
            // .attr("x2",(d3.select(this).attr('x')*2+3.8)/2)
            .attr("x2",(d3.select(this).attr('x')*2+3.8)/2)
            .attr("y2",(d3.select(this).attr('y')*2+7.8)/2);
       div.transition()
          .duration(200)
          .style("opacity",0.9);
      div.html(d.station+""+d.pop)
          .style("left",(d3.event.pageX+7)+"px")
          .style("top",(d3.event.pageY+18)+"px");     
      handlemouseover(d); 
     })
     .on("mouseout",function(d){
      // hightlight.style("display","none");
       div.transition()
          .duration(2000)
          .style("opacity",0);

     });
svg1.selectAll("body")
     .data(stations)
       .enter().append("text")
      .text(i)
      .attr("x",x=i*4)
      .attr("y",-2)
      .attr("transform", "translate(0,-20)")
      // .attr("transform",function(d){return "rotate(90)"})
      .attr("text-anchor", "middle")
      .style("font-family", "Avenir")
      .style("font-size",3.5)
      .style("fill","white");
};
var linecolor=function(LINENO){
 if(LINENO==1){return red;}
 else if(LINENO==2){return lawngreen;}
 else if(LINENO==3){return yellow;}
 else if(LINENO==4){return rebeccapurple;}
 else if(LINENO==5){return mediumslateblue;}
 else if(LINENO==6){return orchid;}
 else if(LINENO==7){return orange;}
 else if(LINENO==8){return blue;}
 else if(LINENO==9){return lightskyblue;}
 else if(LINENO==10){return mediumpurple;}
 else if(LINENO==11){return saddlebrown;}
 else if(LINENO==12){return green;}
 else if(LINENO==13){return lightpink;}
 else if(LINENO==16){return mediumaquamarine;}
};
function Drawstationline(){
var circle= svg1.selectAll("body")
   .data(stationline)
   .enter().append("circle")
   .attr("cx",margin.left+100)
   .attr("cy", function(d){ return d.INDEX*8+4;})
   .attr("id", function(d){ return d.ST_NAME; })
   .attr("r",3.7)
   .attr("transform", "translate(0,-20)")
   .style("fill",function(d){return linecolor(d.LINENO);})
     .on("mouseover",function(d){
       console.log(d);
       console.log(this);
      mouseoverimg(d);
      handlemouseover(d);
       d3.select(this).attr("r",5);
       d3.select(this).attr("opacity",1);
      div.transition()
          .duration(200)
          .style("opacity",0.9);
      div.html("Line"+d.LINENO+". "+d.ST_NAME_EN)
          .style("left",(d3.event.pageX+7)+"px")
          .style("top",(d3.event.pageY-28)+"px");
     })
     .on("mouseout",function(d){
      mouseoutimg(d);
       d3.select(this).attr("r",3.7);
       d3.select(this).attr("opacity",0.8);
       div.transition()
          .duration(500)
          .style("opacity",0);
     });

  svg1.selectAll("body")
     .data(stationline)
       .enter().append("text")
      .text(function(d,i){return (d.LINENO+d.STATION)})
      .attr("x",180)
      .attr("y",function(d){ return (d.INDEX*8+7);})
      .attr("transform", "translate(0,-20)")
      .attr("text-anchor", "end")
      .style("font-family", "Avenir")
      .style("font-size",7)
      .style("fill","white");
}
var ImageRank=function(index){
if(index>=0 && index<41){return 1;}
else if(index>=41 && index<82){return 2;}
else if(index>=82 && index<123){return 3;}
else if(index>=123 && index<164){return 4;}
else if(index>=164 && index<205){return 5;}
else if(index>=205 && index<246){return 6;}
else if(index>=246 && index<287){return 7;}
};

function  Drawstationimg(stationline){
  var imagemouse;
  var imgappend;
  var imgshadow1;
  var imgshadow2;
  var imgshadowL1;  var imgshadowL3;  var imgshadowL5;  
  var imgshadowL2;  var imgshadowL4;   var imgshadowL6;   
  var Row;
  function stationgeoxscale(d){
    return d3.scaleLinear()
             .domain([d3.min(d,function(d){return +d.LNG}),d3.max(d,function(d){return +d.LNG})])
             .range([0,400]);
   };
   function stationgeoyscale(d){
    return d3.scaleLinear()
             .domain([d3.min(d,function(d){return +d.LAT}),d3.max(d,function(d){return +d.LAT})])
             .range([400,0]);
   };
  var description= imgsvg.append("svg:text")
                          .attr('id',"description")
                          .attr('x', 30)
                          .attr('y', 620)
                          .text( "Data visualization plays an important role in urban data analysis that")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("has a huge impact on urban design and research. In this project,")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("Shanghai’s metro data is visualized and data on 2015/04/01 is chosen as an example.")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("Our target is to present ShangHai’s city streaming based on metros’ streaming.")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("And data is collected from ShangHai public transportation released from Shanghai government in 2015")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("We mainly focus on metro streaming and passenger streaming in different stations")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("along the timeline in a particular day. To provide more information for urban data analysis,")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("weather information at different times is added. What’s more is that the spatial division")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("is applied based on ShangHai administrative regions in order to reflect the relationship")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("between metros’ moving and regions’ functionalities.")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("This project aims to build a template for urban subway data visualization in China. ")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("We hope that citizens will have an overall understanding of metro streaming and urban")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 30)
                          .attr('dy', 20)
                          .text("designers will get new insights from our product.")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",10)
                          .style("fill","white")

  var images= imgsvg.selectAll("body")
   .data(stationline)
   .enter().append("svg:image")
                    .attr('id',function(d){return d.ST_NAME_EN;})
                    .attr('x', function(d){return ((d.INDEX%41)*35+30);})
                    .attr('y', function(d){return (ImageRank(d.INDEX)*70);})
                    .attr('width', 100)
                    .attr('height', 45)
                    .attr("row",function(d){return ImageRank(d.INDEX);})
                    .attr("rowNo",function(d){return (d.INDEX%41);})
                    .attr("xlink:href", function(d){return ("/pic/"+d.img);})
                    .style("opacity",0.8)    
                    .on("mouseover",function(d){
                      console.log(d.LINENO)
                      console.log(d);
                      console.log(this);
                      imgRow=(d3.select(this).attr('row'));
                      imgRowNo=(d3.select(this).attr('rowNo'));
                      imgRowX=(d3.select(this).attr('x'));
                      // console.log(imagemouse);
                      imgappend = imgsvg.append("svg:image")
                          .attr('id',"StationImg")
                          .attr('x', (d.INDEX%41)*35-20)
                          .attr('y', ImageRank(d.INDEX)*70)
                          .attr('width', 100)
                    .attr('height', 45)
                    .attr("xlink:href","/pic/"+d.img)
                    .style("pointer-events", "none");
                 
                    imgshadow1=imgsvg.append("rect")
                          .attr('id',"shadow1")
                          .attr('x', 30)
                          .attr('y', ImageRank(d.INDEX)*70)
                          .attr('class','shadow')
                          .attr('width', imgRowX-80)
                          .attr('height', 45)
                    imgshadow2= imgsvg.append("rect")
                          .attr('id',"shadow2")
                          .attr('x', (d.INDEX%41)*35+80)
                          .attr('y', ImageRank(d.INDEX)*70)
                          .attr('class','shadow')
                          .attr('width', 1435-imgRowX)
                          .attr('height', 45);
                
                  imgshadowL1=imgsvg.append("rect")
                          .attr('id',"shadowL1")
                          .attr('x', 30)
                          .attr('y', (ImageRank(d.INDEX)-1)*70)
                          .attr('class','shadowL1')
                          .attr('width', 1465)
                          .attr('height', 45);
                   imgshadowL2=imgsvg.append("rect")
                          .attr('id',"shadowL2")
                          .attr('x', 30)
                          .attr('y', (ImageRank(d.INDEX)+1)*70)
                          .attr('class','shadowL2')
                          .attr('width', 1465)
                          .attr('height', 45);
                   imgshadowL3=imgsvg.append("rect")
                          .attr('id',"shadowL3")
                          .attr('x', 30)
                          .attr('y', (ImageRank(d.INDEX)-2)*70)
                          .attr('class','shadowL3')
                          .attr('width', 1465)
                          .attr('height', 45);
                   imgshadowL4=imgsvg.append("rect")
                          .attr('id',"shadowL4")
                          .attr('x', 30)
                          .attr('y', (ImageRank(d.INDEX)+2)*70)
                          .attr('class','shadowL4')
                          .attr('width', 1465)
                          .attr('height', 45);
                  imgshadowL5=imgsvg.append("rect")
                          .attr('id',"shadowL5")
                          .attr('x', 30)
                          .attr('y', (ImageRank(d.INDEX)-3)*70)
                          .attr('class','shadowL5')
                          .attr('width', 1465)
                          .attr('height', 45);
                   imgshadowL6=imgsvg.append("rect")
                          .attr('id',"shadowL6")
                          .attr('x', 30)
                          .attr('y', (ImageRank(d.INDEX)+3)*70)
                          .attr('class','shadowL6')
                          .attr('width', 1465)
                          .attr('height', 45);

                 var  imgbig = imgsvg.append("svg:image")
                          .attr('id',"StationImgbig")
                          .attr('x', 30)
                          .attr('y', 600)
                          .attr('width', 600)
                    .attr('height', 270)
                    .attr("xlink:href","/pic/"+d.img)
                    .style("pointer-events", "none");

                var  imgbigtext = imgsvg.append("svg:text")
                          .attr('id',"StationImgText")
                          .attr('x', 680)
                          .attr('y', 720)
                          .text( "Line Number:"+""+d.LINENO)
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",14)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 680)
                          .attr('dy', 20)
                          .text("Station Name:" +d.STATION)
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",14)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 680)
                          .attr('dy', 20)
                          .text("Station Name:" + d.ST_NAME_EN)
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",14)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 680)
                          .attr('dy', 20)
                          .text("Station Latitude:" + d.LAT)
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",14)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 680)
                          .attr('dy', 20)
                          .text("Station Longitude:" + d.LNG)
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",14)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x',680)
                          .attr('dy', 20)
                          .text("Transfer Tag:" + d.TRANSFER_TAG)
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",14)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 680)
                          .attr('dy', 20)
                          .text("FIRST_T_TIME:" )
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",14)
                          .style("fill","white")
                          .append('svg:tspan')
                          .attr('x', 680)
                          .attr('dy', 20)
                          .text("LAST_T_TIME:" )
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",14)
                          .style("fill","white")
                    .style("pointer-events", "none");
            var  imgbigline = imgsvg.append("line")
                          .attr('id',"StationImgbigline")
                          .attr('x1', 680)
                          .attr('y1', 680)
                          .attr('x2', 780)
                          .attr('y2', 680)
                          .attr("stroke",linecolor(d.LINENO))
                          .attr("stroke-width",5)
                          .attr("stroke-linecap", "round");
            var  imgbigcircle = imgsvg.append("circle")
                          .attr('id',"StationImgbigcircle")
                          .attr('r',7)
                          .attr('cx', 730)
                          .attr('cy', 680)
                          .style("fill",linecolor(d.LINENO));
               imgsvg.selectAll(".geostationcircle").style("opacity",0.2);
            var cover=imgsvg.append("rect")
                    .attr("id","cover")
                    .attr("x",1000)
                    .attr("y",570)
                    .attr("width",500)
                    .attr("height",500)
                    .style("fill","rgb(30,30,30)")
                    .style("opacity",0.7)
               var changeline= imgsvg.selectAll("body")
                .data(connections)
                .enter().append("line")
                // .attr("class","stationconnect")
                .attr("id","changestationline")
                .attr("stroke",function(x,j){return linecolor(+x[2])})
                .attr("stroke-width",2.5)
                .attr("stroke-linecap", "round")
                .attr("x1", function(x,j) { if(x[2]==d.LINENO)
                {return stationgeox(+(stationsraw[x[0]].LNG))+1000; }})
                .attr("y1", function(x,j) { if(x[2]==d.LINENO)
                {return stationgeoy(+(stationsraw[x[0]].LAT))+570; }})
                .attr("x2", function(x,j) { if(x[2]==d.LINENO)
                {return stationgeox(+(stationsraw[x[1]].LNG))+1000; }})
                .attr("y2", function(x,j) { if(x[2]==d.LINENO)
                {return stationgeoy(+(stationsraw[x[1]].LAT))+570; }})
            var changecircle=imgsvg.append("circle")
                    .attr("id","changecircle")
                    // .attr("class","geostationcircle")
                    .attr("r",7)
                    .attr("cx", stationgeox(+d.LNG)+1000)
                    .attr("cy", stationgeoy(+d.LAT)+570)
                    .style("fill", linecolor(d.LINENO))
                    })
            
                // imgsvg.selectAll(".stationconnect").style("opacity",0.4)
                    .on("mouseout",imgmouseout)
  function imgmouseout(){
    imgsvg.select("#StationImg").remove();
    imgsvg.select("#StationImgbig").remove();
    imgsvg.select("#StationImgbigline").remove();
    imgsvg.select("#StationImgbigcircle").remove();
    imgsvg.select("#StationImgText").remove();
    imgsvg.select("#shadow1").remove();
    imgsvg.select("#shadow2").remove();
    imgsvg.select("#shadowL1").remove();
    imgsvg.select("#shadowL2").remove();
    imgsvg.select("#shadowL3").remove();
    imgsvg.select("#shadowL4").remove();
    imgsvg.select("#shadowL5").remove();
    imgsvg.select("#shadowL6").remove();
    imgsvg.selectAll(".geostationcircle").style("opacity",1);
    imgsvg.select("#changecircle").remove();
    imgsvg.select("#cover").remove();
    imgsvg.selectAll("#changestationline").remove();
    // imgsvg.selectAll(".stationconnect").style("opacity",1);
    // imgsvg.select("#"+String(d.ST_NAME_EN)).attr("r",1.5);
    // d3.select(this).style("opacity",0)
  };

  //Railway Line
  var imgline= imgsvg.selectAll("body")
                       .data(stationline)
                       .enter().append("line")
                       .attr("x1",function(d){return ((d.INDEX%41)*35+30);})
                       .attr("y1",function(d){return (ImageRank(d.INDEX)*70+50);})
                       .attr("x2",function(d){return ((d.INDEX%41)*35+65);})
                       .attr("y2",function(d){return (ImageRank(d.INDEX)*70+50);})
                       .attr("id",function(d){return d.ST_NAME_EN;})
                      //  .attr("class","imgline")
                       .attr("stroke",function(d){return linecolor(d.LINENO);})
                       .attr("stroke-width",2)
                       .attr("stroke-linecap", "round");
  imgsvg.selectAll("body")
     .data(stationline)
       .enter().append("text")
      .text(function(d){return d.STATION;})
      .attr("x",function(d){return ((d.INDEX%41)*35+40);})
      .attr("y",function(d){return (ImageRank(d.INDEX)*70+57);})
      // .attr("transform", "translate(0,-20)")
      // .attr("transform",function(d){return "rotate(90)"})
      .attr("text-anchor", "middle")
      .style("font-family", "Avenir")
      .style("font-size",5)
      .style("fill","white");

//stationGeoMap
   stationgeox=stationgeoxscale(stationline);
   stationgeoy=stationgeoyscale(stationline);
           imgsvg.selectAll("body")
                    .data(stationline)
                    .enter().append("circle")
                    .attr("id",function(d){return d.ST_NAME_EN;})
                    .attr("class","geostationcircle")
                    .attr("r",1.5)
                    .attr("cx",function(d){return stationgeox(+d.LNG)+1000})
                    .attr("cy",function(d){return stationgeoy(+d.LAT)+570})
                    .style("fill",function(d){return linecolor(d.LINENO)})
                    .style("opacity",1)
                    .on("mouseover",function(d){console.log(d);
                    console.log(this);})
          imgsvg.selectAll(".connection")
                .data(connections)
                .enter().append("line")
                .attr("class","stationconnect")
                .attr("id","geostationline")
                .attr("stroke",function(d){return linecolor(+d[2])})
                .attr("stroke-width",1)
                .attr("stroke-linecap", "round")
                .attr("x1", function(d) { return stationgeox(+(stationsraw[d[0]].LNG))+1000; })
                .attr("y1", function(d) { return stationgeoy(+(stationsraw[d[0]].LAT))+570; })
                .attr("x2", function(d) { return stationgeox(+(stationsraw[d[1]].LNG))+1000; })
                .attr("y2", function(d) { return stationgeoy(+(stationsraw[d[1]].LAT))+570; })
                .style("opacity",1)

                var metrotitle= imgsvg.append("svg:text")
                          .attr('id',"metrotitle")
                          .attr('x', 1300)
                          .attr('y', 620)
                          .text( "Shanghai Metro")
                          .attr("text-anchor", "front")
                          .style("font-family", "Avenir")
                          .style("font-size",12)
                          .style("fill","white")
                          // .append('svg:tspan')
                          // .attr('x', 1300)
                          // .attr('dy', 20)
                          // .text("Metro")
                          // .attr("text-anchor", "front")
                          // .style("font-family", "Avenir")
                          // .style("font-size",12)
                          // .style("fill","white")
};

// function Drawstationgeo(stationline){

// }

function geoxscale(d){
    return d3.scaleLinear()
             .domain([d3.min(d,function(d){return +d.LNG}),d3.max(d,function(d){return +d.LNG})])
             .range([0,geocanvas.width]);
   };
function geoyscale(d){
    return d3.scaleLinear()
             .domain([d3.min(d,function(d){return +d.LAT}),d3.max(d,function(d){return +d.LAT})])
             .range([geocanvas.height,0]);
   };

function Drawgeocanvas(stationline){
  geox=geoxscale(stationline);
           geoy=geoyscale(stationline);
           geocanvas.selectAll(".GeoStationDot")
                    .data(stationline)
                    .enter().append("circle")
                    .attr("class","GeoStationDot")
                    .attr("id", function(d){ return d.ST_NAME; })
                    .attr("r",1.2)
                    .attr("cx",function(d){return geox(+d.LNG)})
                    .attr("cy",function(d){return geoy(+d.LAT)})
                    .style("fill","white")
                    .on("mouseover",function(d){
                      console.log(d);
                      console.log(this);
                      console.log(d3.select(this).attr('id'));
                      mouse=(d3.select(this).attr('id'));
                     
                      handlemouseover(d);
                         d3.select(this).attr("r",3);
                         d3.select(this).attr("opacity",1);
                     div.transition()
                        .duration(200)
                        .style("opacity",0.9);
                     div.html(d.ST_NAME+"<div>"+d.ST_NAME_EN+"<div>"+"Line:"+d.LINENO)
                        .style("left",(d3.event.pageX+7)+"px")
                        .style("top",(d3.event.pageY+18)+"px");      
                           })
                    .on("mouseout",function(d){
                        d3.select(this).attr("r",1.2);
                        d3.select(this).attr("opacity",0.5);
                         div.transition()
                            .duration(1000)
                            .style("opacity",0)});
          // console.log(connections)
           geocanvas.selectAll(".connection")
                .data(connections)
                .enter().append("line")
                .attr("class","connection")
                .attr("id",function(d){return d[0]+'-'+d[1]+"line"+d[2];})
                .attr("stroke",function(d){return linecolor(+d[2])})
                .attr("stroke-width",0.9)
                .attr("stroke-linecap", "round")
                .attr("x1", function(d) { return geox(+(stationsraw[d[0]].LNG)); })
                .attr("y1", function(d) { return geoy(+(stationsraw[d[0]].LAT)); })
                .attr("x2", function(d) { return geox(+(stationsraw[d[1]].LNG)); })
                .attr("y2", function(d) { return geoy(+(stationsraw[d[1]].LAT)); })
                .on("mouseover",function(d){
                      console.log(d);
                      console.log(this);
                      console.log(d3.select(this).attr('id'));
                      d3.select(this).attr('id')
                         .attr("stroke-width",3); 
                  
                      handlemouseover(d);
                        //  d3.select(this).attr("stroke-width",3);
                         d3.select(this).attr("opacity",1);})
                    .on("mouseout",function(d){
                        d3.select(this).attr("stroke-width",0.9);});
};

function handlemouseover(d){
        console.log(String(mouse)); 
        MOUSE=String(mouse);
        d3.selectAll("#"+ MOUSE).style("fill","red");
  console.log(stationline)
       geopoint=d.ST_NAME
      //  console.log(geopoint);
        stationline.forEach (function(x,j){
      if(x.ST_NAME==geopoint){
        console.log(x); 
      }
      });
}
function mouseoverimg(d){
   console.log(d.img);
   svg1.append("svg:image")
                    .attr('id',"stationIMG")
                    .attr('x', -50)
                    .attr('y', d.INDEX*8)
                    .attr('width', 200)
                    .attr('height', 248)
                    .attr("xlink:href", "/pic/"+d.img)
}
function mouseoutimg(d){
  svg1.select("#stationIMG").remove();
}
    </script>
   
  </body>
</DOCTYPE>
